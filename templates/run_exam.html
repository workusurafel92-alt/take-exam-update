<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Run Exam</title>
<style>
/* Modern UI Styles */
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(120deg, #f0f3f7, #d9e2ec);
  margin: 0;
  padding: 0;
}
.container {
  max-width: 900px;
  margin: 40px auto;
  background: #fff;
  padding: 35px;
  border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
  transition: transform 0.3s;
}
.container:hover {
  transform: translateY(-5px);
}
h2 {
  text-align: center;
  color: #333;
  font-size: 2em;
  margin-bottom: 10px;
}
h3, h4 {
  text-align: center;
  color: #555;
}
.question {
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 10px;
  margin: 15px 0;
  background: #f9f9fb;
  transition: box-shadow 0.2s;
}
.question:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}
button {
  background: linear-gradient(90deg, #1abc9c, #16a085);
  color: #fff;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s, transform 0.2s;
}
button:hover {
  background: linear-gradient(90deg, #16a085, #149174);
  transform: translateY(-2px);
}
.timer {
  color: #e74c3c;
  font-weight: bold;
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.2em;
}
.banned {
  color: red;
  text-align: center;
  font-weight: bold;
  font-size: 1.5em;
  padding: 50px 20px;
  background: #ffe6e6;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
</style>
</head>
<body>
<div class="container">
  <h2>Take your Exam</h2>
  <h3 id="studentName">Name: {{ name }}</h3>
  <h4>Instruction: Choose the best answer and do not switch tabs.</h4>
  <div class="timer" id="timer"></div>
  <div id="examArea"></div>
  <button id="submitBtn" style="display:none;" onclick="submitExam()">Submit</button>
  <div id="result"></div>
</div>

<script>
// --- Redirect to /dashboard on refresh ---
if (performance.getEntriesByType("navigation")[0].type === "reload") {
    window.location.href = "/dashboard";
}

// --- Exam Logic ---
let exam = null;
let timeLeft = 0, timerInterval;
let banned = false, submitted = false;
let examsList = [];

const studentName = document.getElementById("studentName").textContent.replace("Name: ", "");

async function loadExam() {
  try {
    const studentRes = await fetch('/api/student_info');
    const student = await studentRes.json();
    if (!student.grade || !student.section) {
      alert("Please complete your profile to receive exams!");
      return;
    }

    const res = await fetch(`/api/get_exam?grade=${student.grade}&section=${student.section}`);
    const data = await res.json();

    if (!data || data.length === 0) {
      document.getElementById('examArea').innerHTML = `<p style="text-align:center;">No exam available for your grade and section.</p>`;
      return;
    }

    examsList = data;
    exam = examsList[examsList.length - 1];

    startExam();
  } catch (err) {
    console.error(err);
    alert("Error loading exam!");
  }
}

function startExam() {
  examArea.innerHTML = `<h3>${exam.title}</h3>`;
  exam.questions.forEach((q, i) => {
    let html = `<div class='question'><b>Q${i+1}. ${q.text}</b><br>`;
    ['A','B','C','D'].forEach((opt, j) => {
      html += `<label><input type='radio' name='q${i}' value='${opt}'> ${opt}) ${q.options[j]}</label><br>`;
    });
    html += `</div>`;
    examArea.innerHTML += html;
  });
  submitBtn.style.display = "inline-block";
  startTimer(exam.time * 60);
  document.title = exam.title;

  document.addEventListener('visibilitychange', () => {
    if (!submitted && document.hidden) {
      banned = true;
      alert("üö´ You switched tabs. You are banned!");
      clearInterval(timerInterval);
      document.body.innerHTML = "<div class='banned'>‚ùå You are banned for switching tabs!</div>";
    }
  });
}

function startTimer(seconds) {
  timeLeft = seconds;

  timerInterval = setInterval(() => {
    let m = Math.floor(timeLeft / 60);
    let s = timeLeft % 60;

    timer.textContent = `‚è± Time left: ${m}:${s.toString().padStart(2, '0')}`;
    timeLeft--;

    if (timeLeft < 0) {
      clearInterval(timerInterval);
      document.getElementById("submitBtn").click();
      alert("‚è≥ Time is up! Your exam has been auto-submitted.");
    }
  }, 1000);
}

function submitExam() {
  if (banned || submitted) return;
  submitted = true;
  clearInterval(timerInterval);

  let score = 0;
  exam.questions.forEach((q, i) => {
    const ans = document.querySelector(`input[name='q${i}']:checked`);
    if (ans && ans.value === q.correct) score++;
  });

  const total = exam.questions.length;
  const percentage = Math.round((score / total) * 100);

  examArea.innerHTML = '';
  submitBtn.style.display = "none";
  timer.textContent = '';
  result.innerHTML = `
    <h3>‚úÖ Exam Finished, Good luck {{ name }}</h3>
    <p>Your score: <b>${score}</b> / ${total}</p>
    <p>Percentage: <b>${percentage}%</b></p>
  `;

  fetch('/api/save_result', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      studentName: studentName,
      exam: exam.title,
      score: score,
      total: total,
      percentage: percentage
    })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) console.error("Error saving result:", data.message);
  })
  .catch(err => console.error(err));
}

window.onload = loadExam;
</script>
</body>
</html>
